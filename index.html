<!DOCTYPE html>
<html lang="en" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Star Wars Dice Roller</title>

    <link rel="stylesheet" href="css/bootstrap-flex.css">

    <style type="text/css">
        .die { width: 64px; height: 64px; border: solid 1px black; display: inline-flex; align-items: center; justify-content: center; margin-right: 4px; }
        .die img { display: block; }
        .die.rolled { width: 12px; height: 12px; margin-right: 2px; }

        .die.advantage { background-image: url("images/results/advantage.svg") }
        .die.darkside { background-image: url("images/results/darkside.svg") }
        .die.despair { background: red url("images/results/despair.svg"); }
        .die.failure { background: red url("images/results/failure.svg"); }
        .die.lightside { background-image: url("images/results/lightside.svg") }
        .die.success { background-image: url("images/results/success.svg") }
        .die.threat { background: red url("images/results/threat.svg"); }
        .die.triumph { background-image: url("images/results/triumph.svg") }

        .die.ability { background: green; }
        .die.proficiency { background: yellow; }
        .die.boost { background: blue; }
        .die.challenge { background: red; }
        .die.difficulty { background: purple; }
        .die.setback { background: darkgray; }
        .die.force { background: lightgray; }

        .history { border-top: dashed 1px black; margin-top: 8px; padding-top: 8px; }
    </style>
</head>
<body>
    <div class="container-fluid" id="root">
        <div class="row">
            <div class="col-md">
                <h1>{{ name }}</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-md currentResults">
                <h2>Your current result</h2>

                <div class="dice" id="currentResultsDisplay">
                    <h3>Roll</h3>
                    <rolldie v-bind:die="die" v-for="die in rolls[0].dice"></rolldie>

                    <h3>Results</h3>
                    <resultdie v-bind:die="die" v-for="die in calculateResults(rolls[0].dice)"></resultdie>
                </div>
            </div>

            <div class="col-sm">
                <h2>Everyone's last result</h2>
                <div class="user" v-for="user in users">
                    <h3>{{ user }} <rolleddie v-bind:die="die" v-for="die in rollsFor(user)[0].dice"></rolleddie></h3>
                    <resultdie v-bind:die="roll" v-for="roll in calculateResults(rollsFor(user)[0].dice)"></resultdie>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md">
                <div class="history">
                    <h2>History</h2>
                    <div class="roll" v-for="roll in rolls.slice(0,historyLength)">
                        <div><b>{{ roll.user }}</b> — {{ timeSince(roll.time) }} — <rolleddie v-bind:die="die" v-for="die in roll.dice"></rolleddie></div>
                        <div><resultdie v-bind:die="die" v-for="die in calculateResults(roll.dice)"></resultdie></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="javascript/vue.js"></script>
    <script src="javascript/moment.js"></script>

    <script type="text/x-template" id="rolleddie-template">
        <div class='rolled die' :class='die.type' :title='die.type'>
        </div>
    </script>

    <script type="text/x-template" id="resultdie-template">
        <div class='result die' :class='die'>
        </div>
    </script>

    <script type="text/x-template" id="rolldie-template">
        <div class='roll die' :class='die.type'>
            <div>
                <img :src="'/images/results/'+pip+'.svg'" :width="die.pips.length==1 ? 42 : 28" :height="die.pips.length==1 ? 42 : 28" v-for="pip in die.pips" />
            </div>
        </div>
    </script>

    <script type="text/javascript">
        Vue.component('resultdie', {
            props: ['die'],
            template: "#resultdie-template"
        });

        Vue.component('rolleddie', {
            props: ['die'],
            template: "#rolleddie-template"
        });

        Vue.component('rolldie', {
            props: ['die'],
            template: "#rolldie-template"
        });

        var vm = new Vue({
            el : "#root",
            data: {
                name: "A New Hope",
                historyLength: 2,
                rolls: [
                    {   user: "Inigo",
                        time: moment().subtract(2, 'minutes'),
                        dice: [
                            { type: "ability", pips: [ "advantage", "advantage" ] },
                            { type: "ability", pips: [ "success" ] },
                            { type: "proficiency", pips: [ "triumph" ] },
                            { type: "proficiency", pips: [ "advantage", "success" ] }
                        ]
                    },
                    {   user: "Inigo",
                        time: moment().subtract(10, 'minutes'),
                        dice: [
                            { type: "force", pips: [ "lightside", "lightside" ] },
                            { type: "force", pips: [ "darkside" ] },
                            { type: "ability", pips: [ "advantage" ] },
                            { type: "proficiency", pips: [ "advantage", "success" ] }
                        ]
                    },
                    {   user: "Pete",
                        time: moment().subtract(66, 'minutes'),
                        dice: [
                            { type: "force", pips: [ "darkside", "darkside" ] },
                            { type: "force", pips: [ "darkside" ] }
                        ]
                    }
                ]
            },
            computed: {
                /* Work out the list of unique users based on those that have made rolls. */
                users: function() {
                    return Array.from(new Set(this.rolls.map(roll => roll.user).sort()));
                }
            },
            methods: {
                rollsFor: function(user) {
                    return this.rolls.filter(roll => roll.user === user)
                },
                timeSince: function(time) {
                    return moment(time).fromNow();
                },
                /* Convert a set of rolls into the aggregate result, cancelling successes with failures and so on. */
                calculateResults: function(dice) {
                    var sum = (a, b) => a+b;
                    var flatten = (a, b) => a.concat(b);

                    var allPips = dice.map(die => die.pips).reduce(flatten);

                    var force = allPips.map(pip => pip==="lightside" ? 1 : pip==="darkside" ? -1 : 0 ).reduce(sum);
                    var success = allPips.map(pip => (pip==="success" || pip==="triumph") ? 1 : (pip==="failure" || pip==="despair")? -1 : 0 ).reduce(sum);
                    var advantage = allPips.map(pip => pip==="advantage" ? 1 : pip==="threat" ? -1 : 0 ).reduce(sum);
                    var triumph = allPips.map(pip => pip==="triumph" ? 1 : 0 ).reduce(sum);
                    var despair = allPips.map(pip => pip==="despair" ? 1 : 0 ).reduce(sum);

                    var results = [ Array(Math.abs(force)).fill(force>0 ? "lightside" : "darkside"),
                                    Array(Math.abs(triumph)).fill("triumph"),
                                    Array(Math.abs(success)).fill(success>0 ? "success" : "failure"),
                                    Array(Math.abs(despair)).fill("despair"),
                                    Array(Math.abs(advantage)).fill(advantage>0 ? "advantage" : "threat") ].reduce(flatten);
                    return results;
                }
            }
        });
    </script>
</body>
</html>